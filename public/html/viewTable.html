<!doctype html>
<html lang="en">

<head>
  <title>DB View App</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css" crossorigin="anonymous">
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="jquery.min.js" crossorigin="anonymous"></script>
  <script src="popper.min.js" crossorigin="anonymous"></script>
  <script src="bootstrap.min.js" crossorigin="anonymous"></script>
  <script src="jquery.min.js"></script>

  <script>
    $(document).ready(() => {
      $('#divSelect').hide();
      $('#divCreate').hide();
      $('#alertError').hide();
      $('#alertSuccess').hide();

      $("#queryTable").click(function() {
        $('#divCreate').hide();
        $('#divSelect').show();
      });

      $("#createTable").click(function() {
        $('#divSelect').hide();
        $('#divCreate').show();
      });

      $("#executeQuery").click(function(e) {
        e.preventDefault();
        var createTableElem = $("#createTable");
        console.log(createTableElem.text());
        //alert(createTableElem.text());
      });
      


      $('#btnAddRow .btnNewRow').on('click', function(){
        /*
        var newId = $("#newId").text();
        var newName = $("#newName").text();
        var newAvail = $("#newAvail").text();
        var newAuthor = $("#newAuthor").text();
        var newPrice = $("#newPrice").text();

        var msg = `Write logic to add new row: ${newId}, ${newName}, ${newAvail}, ${newAuthor}, ${newPrice}`;
        console.log(msg);
        $('alertError').show();
        $('#alertErrorMsg').text(`<strong>ERROR: </strong> ${msg}`);
        */
       console.log('btnAddRow clicked.');
      });

      $('#removeRow').click(function(){
        $("#tableData tr:last").remove();
      });

      $('#addRow').click(function(){
        try {
          var newRow = $("<tr>");
          var cols = "";
          cols += '<td class="tdNewRow" ><input id="newId" type="text" class="form-control" placeholder="Enter Next ID" aria-label="Id" aria-describedby="basic-addon1"></td>';
          cols += '<td class="tdNewRow" id="name"><input  id="newName" type="text" class="form-control" placeholder="Enter Name" aria-label="Name" aria-describedby="basic-addon1"></td>';
          cols += '<td class="tdNewRow" id="availabity"><input  id="newAvail" type="text" class="form-control" placeholder="Avaliable?" aria-label="Availability" aria-describedby="basic-addon1"></td>';
          cols += '<td class="tdNewRow" id="author"><input  id="newAuthor" type="text" class="form-control" placeholder="Author" aria-label="Author" aria-describedby="basic-addon1"></td>';
          cols += '<td class="tdNewRow" id="price"><input  id="newPrice" type="text" class="form-control" placeholder="Price" aria-label="Price" aria-describedby="basic-addon1"></td>';
          cols += '<td class="rowNew"> <img id="removeRow" class="rowDelete" src="trash.svg" /> <button id="btnAddRow" class="btn btn-primary btn-sm btnNewRow">Add Row</button></td>';

          newRow.append(cols);
          $("#tableData .thead-light").append(newRow);
        } catch(err) {
          console.error('ERROR: ', err);
        }
      });

      $("#tableData").on('click','.rowDelete',function(){
        var currentRow=$(this).closest("td");
        var row = $(this).closest("tr");
        var rowId =$(this).closest("tr").find('td:first').text().trim();
        var column = currentRow.attr('id');
        var value=currentRow.html();
        var tableName = $( "#tableSelect option:selected" ).text();
        var urlDelete = `http://localhost:3000/db/table/delete/${tableName}/${rowId}`;
        console.log("rowDelete - "+ urlDelete);

        $.ajax({
        url: urlDelete,
        method: 'DELETE',
        success: function (response) {
          $('#alertSuccessMsg').text('<strong>SUCCESS: </strong> Row deleted successfully from the table. ');
          $('alertError').show();
        },
        error: function(err) {
          $('#alertErrorMsg').text('<strong>ERROR: </strong> Failed to delete row from the table. ');
          $('alertError').show();
        }
      });

      row.remove();
    });


      $.ajax({
        url: `http://localhost:3000/db/json`,
        method: 'GET',
        success: function (response) {
          var cols = '';
          if (response.length > 0) {
            for (let index = 0; index < response.length; index++) {
              $('#tableSelect').append($('<option>',
                {
                    value: 'option_'+index,
                    text : response[index].name
                }));
            }
          }
        }
      })

      $("#tableData").on('click','.tdClass',function(){
        var currentRow=$(this).closest("td");
        var rowId =$(this).closest("tr").find('td:first').text().trim();
        var column = currentRow.attr('id');
        var value=currentRow.html();
        var tableName = $( "#tableSelect option:selected" ).text();
        //console.log("Table Name: " + tableName);

        var me = currentRow
        me.hide();
        me.after(`<input id="tmpInput" style="padding: 0.5rem;" value="${value}">`);
        $("#tmpInput").focus();
        $("#tmpInput").bind("keyup", function(e) {
            e.preventDefault();
            if (e.keyCode == '13') {
                var newValue = $(this).val();
                $(this).remove();
                if(me.is("input")) {
                    me.val(newValue);
                } else {
                    me.text(newValue);
                }
                me.show();

                var url = `http://localhost:3000/db/table/update/${tableName}/${column}/${rowId}`;
                console.log("URL: " + url);
                

                $.post(url, {"newValue": newValue}, function (response) {
                        console.log("Updated successfully !")
                    }
                ); 
            }
            return false;
        });

        $("#tmpInput").blur(function(){
          var newValue = $(this).val();
          if (newValue.length == 0 || newValue == value) {
            $(this).remove();
            me.show();
          }
        });

      });

      $('#tableSelect').on('change', function(e) {
          $("#tableData .thead-light").empty();
                    var tableName = $( "#tableSelect option:selected" ).text();
                    console.log('option selected: ' + tableName);
                    if (tableName) {
                      $.ajax({
                            url: `http://localhost:3000/db/table/${tableName}`,
                            method: 'GET',
                            success: function (response) {
                              if (response.length > 0) {
                                for (let index = 0; index < response.length; index++) {
                                  try {
                                    var newRow = $("<tr>");
                                    var cols = "";
                                    cols += '<td class="tdClass" > ' + response[index].id + '</td>';
                                    cols += '<td class="tdClass" id="name"> ' + response[index].name + '</td>';
                                    cols += '<td class="tdClass" id="availabity"> ' + response[index].availabity + '</td>';
                                    cols += '<td class="tdClass" id="author"> ' + response[index].author + '</td>';
                                    cols += '<td class="tdClass" id="price"> ' + response[index].price + '</td>';
                                    cols += '<td class="rowDelete"><img src="trash.svg" /></td>';

                                    newRow.append(cols);
                                    $("#tableData .thead-light").append(newRow);
                                  } catch(err) {
                                    console.error('ERROR: ', err);
                                  }
                                }
                              }
                            }
                          })
                      }
                });
    });


  </script>
</head>

<body>
  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top nav-block">
    <img class="logo-icon" src="favicon.ico" /><h1>DB View</h1>
  </nav>
  <div class="container container-sm main-section">
    <h3>What would you like to do ? </h3><hr/>
    <div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="tableOptions" id="queryTable" value="queryTable">
        <label class="form-check-label" for="queryTable">Query table</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="tableOptions" id="createTable" value="createTable">
        <label class="form-check-label" for="createTable">Create table</label>
      </div>
    </div>
    
    <div id="divSelect" class="div-select">
      Show data for table  
      <select id="tableSelect" class="form-select" aria-label="Default select example">
        <option class="opt"></option>
      </select> <hr/>

      <table  id="tableData" 
              data-toggle="table"
              data-search="true"
              data-filter-control="true" 
              data-show-export="true"
			        data-click-to-select="true"
			        data-toolbar="#toolbar"
              class="table table-sm table-hover db-table">
        <thead class="thead-dark">
          <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Availability</th>
            <th>Author</th>
            <th>Price</th>
            <th>Operations</th>
          </tr>
        </thead>
        <tbody class="thead-light">
        </tbody>
      </table>
      <button id="addRow" type="button" class="btn btn-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" 
        class="bi bi-plus" 
        viewBox="0 0 16 16">  
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"></path>
        </svg>
      </button>
    </div>

    <div>
    <div>
      <div id="alertError" class="alert alert-warning alert-dismissible fade show" role="alert">
        <p id="alertErrorMsg"><strong>ERROR</strong> Row deleted successfully. </p>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
    <div>
      <div id="alertSuccess" class="alert alert-success alert-dismissible fade show" role="alert">
        <p id="alertSuccessMsg"><strong>SUCCESS</strong> Row deleted successfully. </p>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
  </div>

    <div id="divCreate" class="div-create query-execute">
      <div class="row">
        <div class="col-lg">
          <textarea name="createTable" id="createTable" cols="30" rows="10"></textarea>
        </div>
      </div>
      <div class="row">
        <button 
          id="executeQuery" 
          class="btn btn-success execute-btn">Execute</button>
      </div>
    </div>
  </div>
</body>

</html>